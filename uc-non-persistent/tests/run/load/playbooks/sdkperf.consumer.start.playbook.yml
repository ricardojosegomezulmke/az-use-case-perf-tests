# ---------------------------------------------------------------------------------------------
# MIT License
# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke (ricardo.gomez-ulmke@solace.com)
# ---------------------------------------------------------------------------------------------

---
- name: "SDKPerf Start Consumers"
  hosts: sdkperf_consumers
  gather_facts: no
  pre_tasks:
    - include_vars:
        file: "{{ RUN_SPEC_FILE }}"
        name: run_spec
    - include_vars:
        file: "load.vars.yml"
        name: load
  vars:
    broker_uri: "tcp://{{ broker_pubsub.private_ip_address }}"
    broker_smf_port: 55555

  tasks:

    - name: "Check Env Vars"
      debug:
        msg:
          - "RUN_LOG_FILE_BASE={{ RUN_LOG_FILE_BASE }}"

    - name: "Set SDKPerf Parameters"
      set_fact:
        sdkperf_exe: "{{sdkperf_root}}/sdkperf/sdkperf_c.sh"
        sdkperf_connection: "{{ broker_uri }}:{{ broker_smf_port }}"
        sdkperf_client_username_prefix: "sdkperf-load@{{ boxname }}"
        sdkperf_user: "{{ broker_pubsub.client_user_name }}@{{ broker_pubsub.vpn_name }}"
        sdkperf_pwd: "{{ broker_pubsub.client_user_name_pwd }}"
        sdkperf_rc: "{{ load.sdkperf.rc }}"
        sdkperf_epl: "{{ load.sdkperf.epl }}"

    - name: "Ensure no SDKPerf exes are running"
      become: true
      command: pkill --signal 2 -f sdkperf
      ignore_errors: true

    - pause:
        seconds: 3
        prompt: "Waiting 3 seconds ...."

    - name: "Check if any consumers defined"
      meta: end_play
      when: run_spec.load.subscribe.consumers == ''

    - name: "Iterate over Consumers"
      include_tasks: ./tasks/consumer.start.yml
      loop: "{{ run_spec.load.subscribe.consumers }}"
      loop_control:
        index_var: consumer_num
        loop_var: consumer
###
# The End.
