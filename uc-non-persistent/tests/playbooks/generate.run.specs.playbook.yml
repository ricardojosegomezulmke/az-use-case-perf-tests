
# ---------------------------------------------------------------------------------------------
# MIT License
# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke (ricardo.gomez-ulmke@solace.com)
# ---------------------------------------------------------------------------------------------

---
- name: "Generate Run Specs"
  hosts: localhost
  gather_facts: no
  pre_tasks:
    - include_vars: "{{TEST_SPEC_FILE}}"
  vars:
    test_specs_j2_template_file: "./lib/test_specs.j2"

  tasks:

    - name: "Check Env Vars"
      debug:
        msg:
          - "TEST_SPEC_DIR={{TEST_SPEC_DIR}}"
          - "SHARED_SETUP_DIR={{SHARED_SETUP_DIR}}"

    - name: "Ensure {{ TEST_SPEC_DIR }} exists"
      local_action:
        module: file
        path: "{{TEST_SPEC_DIR}}"
        state: directory

    - name: "Ensure {{ SHARED_SETUP_DIR }} exists"
      local_action:
        module: file
        path: "{{SHARED_SETUP_DIR}}"
        state: directory

    - name: "Ensure {{ test_specs_j2_template_file }} exists"
      local_action:
        module: file
        path: "{{test_specs_j2_template_file}}"
        state: file

    - name: "Settings"
      set_fact:
        generated_test_specs_file: "{{ TEST_SPEC_DIR }}/{{test_spec.name}}.test.spec.inventory.json"

    - name: "Initialize Test Spec Data Structure"
      set_fact:
        generated_test_specs: {}

    - name: "Iterate over infrastructures"
      include_tasks: ./tasks/generate.infrastructure.yml
      loop: "{{ test_spec.infrastructure_list }}"
      loop_control:
        index_var: infrastructure_num
        loop_var: infrastructure

    - debug:
        msg: "{{generated_test_specs}}"

    - name: "Write Generated Test Specs Inventory"
      template:
        src: "{{ test_specs_j2_template_file }}"
        dest: "{{ generated_test_specs_file }}"
###
# The End.
