
# ---------------------------------------------------------------------------------------------
# MIT License
# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke (ricardo.gomez-ulmke@solace.com)
# ---------------------------------------------------------------------------------------------

---

  - name: "Run Test"
    debug:
      msg:
        - "run_num={{run_num}}"
        - "run="
        - "{{run}}"

  - name: "Run Settings"
    set_fact:
      run_name: "{{run.key}}"
      run_spec: "{{run.value}}"
  - set_fact:
      run_spec_file: "{{RUN_SPECS_DIR}}/{{infrastructure_id}}.{{run_name}}.yml"
      run_log_file_base: "{{LOG_DIR}}/{{infrastructure_id}}.{{run_name}}"

  - name: "Write Run Spec to File"
    copy:
      content: "{{ run_spec | to_nice_yaml }}"
      dest: "{{run_spec_file}}"
    delegate_to: localhost


# TODO
# RUN_ID_PREFIX=?

  - name: "Run Test"
    shell: >
      export UC_NON_PERSISTENT_INFRASTRUCTURE={{infrastructure_id}};

      export RUN_SPEC_FILE={{run_spec_file}}

      export RUN_LOG_FILE_BASE={{run_log_file_base}};

      D=$(date -u +"%Y-%m-%d-%H-%M-%S");
      export RUN_ID=$RUN_ID_PREFIX$D;

      export RUN_NAME={{run_name}};

      export IS_RUN_MONITOR_VPN_STATS={{'true' if run_spec.monitors.vpn_stats.include else ''}};
      export IS_RUN_MONITOR_LATENCY={{'true' if run_spec.monitors.latency.sdkperf_node_to_broker.include else ''}};
      export IS_RUN_MONITOR_BROKERNODE_LATENCY={{'true' if run_spec.monitors.latency.broker_node_to_broker.include else ''}};
      export IS_RUN_MONITOR_PING={{'true' if run_spec.monitors.ping.include else ''}};

      export RUN_START_TS_EPOCH_SECS=$(date -u +%s);

      {{RUN_SCRIPTS_DIR}}/{{run_script}} > {{run_log_file_base}}.{{run_script}}.log 2>&1

    delegate_to: localhost
    register: run_script_result
    when: is_run_tests

    # TODO:
    # failed_when: "'Exception' in sdkperf_result.stderr or sdkperf_result.stdout == ''"


###
# The End.
