# ---------------------------------------------------------------------------------------------
# MIT License
# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke (ricardo.gomez-ulmke@solace.com)
# ---------------------------------------------------------------------------------------------

---

- set_fact:
    sample_start_timestamp: "{{now(True)}}"
    sample_num: "{{item}}"

- name: "Ping broker node..."
  shell: "ping -c {{ping.msg_number}} -q {{broker_pubsub.private_ip_address}} > {{sdkperf_nodes.sdkperf_log_root}}/{{sdkperf.ping_log_filename}}"
  register: ping_result
  ignore_errors: true

- name: "Wait for PING to collect results"
  pause:
    seconds: "{{ping.pause_between_calls_secs}}"

- name: "Download PING log file to local tmp"
  become: true
  fetch:
    src: "{{sdkperf_nodes.sdkperf_log_root}}/{{sdkperf.ping_log_filename}}"
    dest: "./tmp/ping/ping-stats.current.log"
    flat: yes
  register: result

- name: "Post-process ping log file"
  shell: "cat {{ result.dest }} | ./lib/post-process.ping.sh ./lib/ping.template.json '{{sample_start_timestamp}}'"
  environment:
    RUN_ID: "{{run_id}}"
    SAMPLE_NUM: "{{sample_num}}"
  delegate_to: localhost
  register: pp_result
  failed_when: pp_result.stderr != '' or pp_result.rc > 0

- set_fact:
    pp_ping_json: "{{pp_result.stdout | from_json}}"

- name: "Display Post-Processed Ping Result"
  debug:
    msg: "{{pp_ping_json}}"

- name: "Copy Ping Json to {{ result_dir }}"
  local_action:
    module: copy
    content: "{{pp_ping_json | to_nice_json }}"
    dest: "{{ result_dir }}/ping-stats.{{sample_start_timestamp}}.json"
  when: pp_ping_json.metrics.ping.rtt_avg.value != -1

- name: "Delete ping log file on server"
  become: true
  file:
    path: "{{sdkperf_nodes.sdkperf_log_root}}/{{sdkperf.ping_log_filename}}"
    state: absent

###
# The End.
