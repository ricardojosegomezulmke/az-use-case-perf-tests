
# ---------------------------------------------------------------------------------------------
# MIT License
# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke (ricardo.gomez-ulmke@solace.com)
# ---------------------------------------------------------------------------------------------

---
- name: "Broker PubSub Shutdown"
  hosts: broker_pubsub
  gather_facts: no
  vars:
    project_root_dir: "../../../"

  module_defaults:
    solace_get_available:
      host: "{{ sempv2_host }}"
      port: "{{ sempv2_port }}"
      secure_connection: "{{ sempv2_is_secure_connection }}"
      username: "{{ sempv2_username }}"
      password: "{{ sempv2_password }}"
      timeout: "{{ sempv2_timeout }}"
    solace_client_username:
      host: "{{ sempv2_host }}"
      port: "{{ sempv2_port }}"
      secure_connection: "{{ sempv2_is_secure_connection }}"
      username: "{{ sempv2_username }}"
      password: "{{ sempv2_password }}"
      timeout: "{{ sempv2_timeout }}"

  pre_tasks:
    - set_fact:
        use_case_root_dir: "{{project_root_dir}}/uc-non-persistent"
    - include_vars:
        file: "{{use_case_root_dir}}/ansible/vars/bootstrap.vars.yml"
        name: bootstrap
    - include_vars:
        file: "{{use_case_root_dir}}/ansible/vars/monitor.vars.yml"
        name: monitor

  tasks:

    - set_fact:
        admin_protocol: "{{ 'https' if sempv2_is_secure_connection else 'http' }}"
        is_solace_cloud: "{{ True if sempv2_is_secure_connection else False }}"

    - name: "Check Imports / Version / Interpreter"
      solace_get_available:
      register: result
      # fail_when: "result.rc != 0 and not result.is_available"
      until: "result.rc == 0 and result.is_available"
      retries: 1
      delay: 1

    - name: "Disable Client Username"
      solace_client_username:
        name: "{{ bootstrap.broker.pubsub.client_user_name }}"
        msg_vpn: "{{ bootstrap.broker.pubsub.vpn_name }}"
        settings:
          enabled: false
        state: present

    - name: "Wait for 2 x sample_run_time_secs = {{ 2 * monitor.general.sample_run_time_secs }}"
      pause:
        seconds: "{{2 * monitor.general.sample_run_time_secs | int}}"

    - name: "Enable Client Username"
      solace_client_username:
        name: "{{ bootstrap.broker.pubsub.client_user_name }}"
        msg_vpn: "{{ bootstrap.broker.pubsub.vpn_name }}"
        settings:
          enabled: true
        state: present

###
# The End.
