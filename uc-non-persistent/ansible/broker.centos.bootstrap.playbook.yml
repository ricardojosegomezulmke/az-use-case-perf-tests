#!/bin/bash
# ---------------------------------------------------------------------------------------------
# MIT License
# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke (ricardo.gomez-ulmke@solace.com)
# ---------------------------------------------------------------------------------------------

---
- hosts: broker_centos

  pre_tasks:
    - include_vars:
        file: "./vars/bootstrap.vars.yml"
        name: bootstrap

  tasks:

    - name: "Check local docker image exists"
      local_action:
        module: stat
        path: "{{ bootstrap.broker.docker_image.solace_image_file_src }}"
        follow: yes
      register: result
    - fail:
        msg: "docker image file does not exist: {{ bootstrap.broker.docker_image.solace_image_file_src }}"
      when: result.stat.exists == False

    - name: "Extract the manifest from docker tar"
      local_action:
        module: command
        cmd: "tar -C ./docker-image --extract --file={{ bootstrap.broker.docker_image.solace_image_file_src }} manifest.json"
    - set_fact:
        manifest: "{{lookup('file', './docker-image/manifest.json')}}"
        configured: "{{bootstrap.broker.docker_image.solace_image_name}}:{{bootstrap.broker.docker_image.solace_image_version}}"
    - name: "Compare versions of docker image"
      fail:
        msg:
          - "Different version of docker image and configuration. fix either one."
          - "manifest.RepoTags[0]={{manifest[0].RepoTags[0]}}"
          - "bootstrap.vars.yml={{configured}}"
      when: manifest[0].RepoTags[0] != configured

    - name: "Centos Bootstrap: Setup Swap Tasks"
      include_tasks: ./tasks/centos.bootstrap.yml

    - name: "Broker Bootstrap: Setup External Storage Tasks"
      include_tasks: ./tasks/centos.bootstrap.ext-storage.yml

    - name: "Docker Bootstrap: Install Docker CE"
      include_role:
        name: centos/suzuki-shunsuke.docker_ce_centos
      vars:
        docker_centos_users: "{{ bootstrap.broker.centos_docker.docker_centos_users }}"
        docker_centos_version: "{{ bootstrap.broker.centos_docker.docker_centos_version }}"
        docker_centos_state: "{{ bootstrap.broker.centos_docker.docker_centos_state }}"
        docker_centos_enabled: "{{ bootstrap.broker.centos_docker.docker_centos_enabled }}"
        docker_centos_daemon_config: "{{ bootstrap.broker.centos_docker.docker_centos_daemon_config }}"

    - name: "Docker Bootstrap: Install docker-compose"
      get_url:
        url : "https://github.com/docker/compose/releases/download/1.25.4/docker-compose-{{ ansible_system }}-{{ ansible_userspace_architecture }}"
        dest: "/usr/local/bin/docker-compose"
        mode: "u=rwx,g=rx,o=rx"

    - name: "Copy docker image to broker node"
      copy:
        src: "{{ bootstrap.broker.docker_image.solace_image_file_src }}"
        dest: "{{ bootstrap.broker.docker_image.solace_image_file_dest }}"
        owner: "{{ bootstrap.broker.docker_image.file_owner }}"
        mode: "{{ bootstrap.broker.docker_image.file_mode }}"

    - name: "Load Solace Docker Image"
      command: docker load -i {{ bootstrap.broker.docker_image.solace_image_file_dest }}

    - name: "Copy docker-compose template to broker node"
      template:
        src: "{{ bootstrap.broker.docker_image.docker_compose_file_src }}"
        dest: "{{ bootstrap.broker.docker_image.docker_compose_file_dest }}"
        owner: "{{ bootstrap.broker.docker_image.file_owner }}"
        mode: "{{ bootstrap.broker.docker_image.file_mode }}"

    - name: "Start Solace Broker Docker Container"
      command: /usr/local/bin/docker-compose -f {{ bootstrap.broker.docker_image.docker_compose_file_dest }} up -d

###
# The End.
