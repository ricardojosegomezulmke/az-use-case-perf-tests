
# ---------------------------------------------------------------------------------------------
# MIT License
# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke (ricardo.gomez-ulmke@solace.com)
# Copyright (c) 2020, Solace Corporation, Jochen Traunecker (jochen.traunecker@solace.com)
# ---------------------------------------------------------------------------------------------

---
- name: "Bootstrap Optimizations"
  # hosts: sdkperf_publishers, sdkperf_consumers, sdkperf_latency, broker_centos
  hosts: sdkperf_publishers
  any_errors_fatal: true
  gather_facts: yes
  pre_tasks:
    - include_vars:
        file: optimization.vars.yml
        name: optimization
  # vars:
  #   deployed_dir: "{{USE_CASE_DIR}}/infrastructure/standalone/.deployed"
  vars:
    apply_kernel_optimizations: "{{ APPLY_KERNEL_OPTIMIZATIONS | default(False) }}"
    apply_mellanox_vma: "{{ APPLY_MELLANOX_VMA | default(False) }}"


  tasks:
    - name: "CHECK NOT_A_HOST: end_host"
      meta: end_host
      when: inventory_hostname == 'NOT_A_HOST'

    - name: "CHECK cloud_provider: azure only"
      fail:
        msg: "Optimizations only supported for cloud_provider=azure"
      when: cloud_provider != "azure" and (apply_kernel_optimizations|bool or apply_mellanox_vma|bool)




    - name: check some facts
      debug:
        msg:
          # - "ansbile_facts="
          # - "{{ ansible_facts }}"
          - "distribution={{ ansible_facts.distribution }}"
          - "distribution_major_version={{ ansible_facts.distribution_major_version }}"
          - "distribution_release={{ ansible_facts.distribution_release }}"
          - "distribution_version={{ ansible_facts.distribution_version }}"

    # - meta: end_play

    # TODO: select the kernel optimizations based on version
            # "distribution=CentOS",
            # "distribution_major_version=8",
            # "distribution_release=Core",
            # "distribution_version=8.2"






    - name: "Kernel Optimizations: sysctl"
      sysctl:
        name: '{{ item.key }}'
        value: '{{ item.value }}'
        sysctl_set: yes
        state: present
        reload: yes
      with_dict: '{{ optimization.kernel.sysctl_conf }}'
      when: apply_kernel_optimizations|bool
      become: true

    - name: "Apply Mellanox VMA"
      fail:
        msg: "MELLANOX VMA: NOT IMPLEMENTED"
      when: apply_mellanox_vma|bool


###
# The End.
